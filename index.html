<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DT QR Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- QR Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #ffffff;
      text-align: center;
      padding: 20px;
    }

    h2 {
      margin-bottom: 5px;
    }

    #reader {
      width: 320px;
      margin: 20px auto;
    }

    .status {
      margin-top: 20px;
      font-size: 15px;
      padding: 10px;
      border-radius: 6px;
    }

    .ok {
      background: #064e3b;
      color: #22c55e;
    }

    .error {
      background: #7f1d1d;
      color: #fecaca;
    }

    .info {
      color: #94a3b8;
      font-size: 13px;
    }
  </style>
</head>

<body>

  <h2>ðŸ“¸ DT Tailing QR Scan</h2>
  <p class="info">Arahkan kamera ke QR Dump Truck</p>

  <div id="reader"></div>

  <div id="result" class="status info">
    Menunggu scan QR...
  </div>

  <script>
    /**********************************************************
     * âš ï¸ GANTI IP SERVER SESUAI FASTAPI KAMU
     **********************************************************/
    const SERVER_API = "http://192.168.1.20:8000/api/scan";
    // contoh: http://10.130.53.115/:8000/api/scan

    const resultDiv = document.getElementById("result");
    let lastScan = "";
    let lockScan = false;

    function onScanSuccess(decodedText) {
      if (lockScan) return;
      if (decodedText === lastScan) return;

      lockScan = true;
      lastScan = decodedText;

      resultDiv.className = "status info";
      resultDiv.innerHTML = "â³ Mengirim data ke server...";

      fetch(SERVER_API, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ dt_id: decodedText })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          resultDiv.className = "status ok";
          resultDiv.innerHTML = `
            âœ… <b>${data.dt_id}</b><br>
            Event: <b>${data.event}</b><br>
            Time: ${data.time}
          `;
        } else {
          resultDiv.className = "status error";
          resultDiv.innerHTML = `âŒ ${data.message || "Scan gagal"}`;
        }
      })
      .catch(err => {
        resultDiv.className = "status error";
        resultDiv.innerHTML = "âŒ Tidak bisa terhubung ke server";
        console.error(err);
      })
      .finally(() => {
        setTimeout(() => {
          lockScan = false;
          lastScan = "";
        }, 3000); // cooldown 3 detik
      });
    }

    function onScanFailure(error) {
      // sengaja dikosongkan (noise camera)
    }

    const html5QrcodeScanner = new Html5QrcodeScanner(
      "reader",
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      false
    );

    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
  </script>

</body>
</html>
